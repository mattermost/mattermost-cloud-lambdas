name: upload-lambda-action
description: Reusable action to build and upload Lambda to S3

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@5126516654c75f76bca1de45dd82a3006d8890f9

    - name: Build ${{ env.LAMBDA_NAME }} zip
      shell: bash
      run: |
        cd $LAMBDA_NAME
        make
        mkdir -p zip/
        mv *.zip zip/

    - name: Extract branch name
      shell: bash
      id: extract_branch
      run: |
        echo "branch=$(echo \"${GITHUB_REF_NAME//\//-}\")" >> $GITHUB_OUTPUT

    - name: Sync Lambda ZIP to S3
      run: |
        aws s3 sync \
          "${{ env.LAMBDA_NAME }}/zip" \
          "s3://mattermost-cloud-lambdas-${{ env.ENVIRONMENT }}/${{ env.LAMBDA_NAME }}/${{ steps.extract_branch.outputs.branch }}/${{ github.run_number }}"
